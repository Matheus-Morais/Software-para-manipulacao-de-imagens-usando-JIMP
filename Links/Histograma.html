<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Laboratório JIMP</title>
    <script src="https://cdn.rawgit.com/oliver-moran/jimp/v0.2.27/browser/lib/jimp.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">

        var imagem_atual = null;
        function mostrarImagem(element) {
            var arquivo = element.files[0];
            var reader = new FileReader();
            reader.readAsArrayBuffer(arquivo);
            reader.addEventListener('load', function(){
                Jimp.read(this.result)
                    .then(function(imagem){
                        imagem = imagem.resize(120, 100);
                        imagem_atual = imagem;
                        exibirImagem(imagem);
                    })
                    .catch(function(erro){
                        console.log('Não foi possível processar os dados da imagem.');
                        console.log(erro);
                    });

            });
        }

        function exibirImagem(imagem) {
            imagem.getBase64(Jimp.MIME_JPEG, function(err, src){
                var img = document.getElementById('display');
                img.setAttribute('src', src);
            });
        }

        function threshold_filter(v, t) {
            if (v <= t) {
                return 0;
            } else {
                return 255;
            }
        }

        function aplicarThreshold(element) {
            console.log("hellow");
            var t = parseInt(element.value);
            var w = imagem_atual.bitmap.width;
            var h = imagem_atual.bitmap.height;

            var imagem = imagem_atual.clone();
            vetorR = [];
            vetorG = [];
            vetorB = [];
            for(var i =0; i< 256; i++){
                vetorR.push(0);
                vetorG.push(0);
                vetorB.push(0);
            }

            for(var i = 0; i < w; i++) {
                for(var j = 0; j < h; j++) {
                    var cor = imagem.getPixelColor(i, j);
                    var rgba = Jimp.intToRGBA(cor);
                    vetorR[rgba.r]++;
                    vetorG[rgba.g]++;
                    vetorB[rgba.b]++;
                }
            }
                       
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);
        }
        
        function histograma(element) {
            console.log("hellow");
            var t = parseInt(element.value);
            var w = imagem_atual.bitmap.width;
            var h = imagem_atual.bitmap.height;

            var imagem = imagem_atual.clone();
            vetorR = [];
            vetorG = [];
            vetorB = [];
            vetorRn = [];
            vetorGn = [];
            vetorBn = [];
            for(var i =0; i< 256; i++){
                vetorR.push(0);
                vetorG.push(0);
                vetorB.push(0);
                vetorRn.push(0);
                vetorGn.push(0);
                vetorBn.push(0);
            }

            for(var i = 0; i < w; i++) {//histograma 
                for(var j = 0; j < h; j++) {
                    var cor = imagem.getPixelColor(i, j);
                    var rgba = Jimp.intToRGBA(cor);
                    vetorR[rgba.r]++;
                    vetorG[rgba.g]++;
                    vetorB[rgba.b]++;
                
                }
            }
            
            for(var i = 0; i < w; i++) {//histograma normalizado
                for(var j = 0; j < h; j++) {
                    var cor = imagem.getPixelColor(i, j);
                    var rgba = Jimp.intToRGBA(cor);
                    
                    vetorRn[rgba.r] += Math.floor(vetorR[rgba.r] /12000);
                    vetorGn[rgba.g] += Math.floor(vetorR[rgba.g] /12000);
                    vetorBn[rgba.b] += Math.floor(vetorR[rgba.b] /12000);               
                }
            }
            for(var i = 0; i < w; i++) {//Histograma acumulado normalizado
                for(var j = 0; j < h; j++) {
                    var cor = imagem.getPixelColor(i, j);
                    var rgba = Jimp.intToRGBA(cor);
                    if(j == 0){
                        vetorR[rgba.r] = vetorRn[rgba.r];
                        vetorG[rgba.g] = vetorGn[rgba.g];
                        vetorB[rgba.b] = vetorBn[rgba.b];
                    }
                    else{
                        var cor2 = imagem.getPixelColor(i, j-1);
                        var rgba2 = Jimp.intToRGBA(cor2);
                        vetorR[rgba.r] += vetorRn[rgba.r] + vetorRn[rgba2.r];
                        vetorG[rgba.g] += vetorGn[rgba.g] + vetorGn[rgba2.g];
                        vetorB[rgba.b] += vetorBn[rgba.b] + vetorBn[rgba2.b];
                    }               
                }
            }
            for(var i = 0; i < w; i++) { //equalização de histograma
                for(var j = 0; j < h; j++) {
                    var cor = imagem.getPixelColor(i, j);
                    var rgba = Jimp.intToRGBA(cor);
                    var r = verifica(vetorR[rgba.r]);
                    var g = verifica(vetorR[rgba.g]);
                    var b = verifica(vetorR[rgba.b]);
                    
                    var hex = Jimp.rgbaToInt(r, g, b, rgba.a);
                    imagem.setPixelColor(hex, i, j);
                }
            }
            exibirImagem(imagem);
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart2);
        }            

        function verifica(valor){
            var x = valor;
            if( x > 255){
                x = 255;
            }
            else if(x < 0){
                x = 0;
            }
            return x;
        }

        function drawChart() {
            var aux=[];
            aux.push( ['Histograma','R', 'G', 'B']);
            for(var i =0; i< 256; i++){
               aux.push([i,vetorR[i],vetorG[i],vetorB[i]]);
            }
            var data = google.visualization.arrayToDataTable(aux);

            var options = {
                title: 'Histograma',
                hAxis: {title: 'Pixel',  titleTextStyle: {color: '#333'}},
                vAxis: {minValue: 0}
            };

            var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        }
        function drawChart2() {
            var aux=[];
            aux.push( ['Histograma','R', 'G', 'B']);
            for(var i =0; i< 256; i++){
               aux.push([i,vetorR[i],vetorG[i],vetorB[i]]);
            }
            var data = google.visualization.arrayToDataTable(aux);

            var options = {
                title: 'Histograma Equalizado',
                hAxis: {title: 'Pixel',  titleTextStyle: {color: '#333'}},
                vAxis: {minValue: 0}
            };

            var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
            chart.draw(data, options);
        }
    </script>
</head>
<body>
<p>Escolha um arquivo de imagem</p>
<input type="file" onchange="mostrarImagem(this)">
<p>Aplique o histograma</p>
<input type="button" id="valor-threshold" value="Aplicar Histograma" onclick="aplicarThreshold(this)">
<p>Aplique o histograma equalizado</p>
<input type="button" id="valor-threshold" value="Aplicar Histograma" onclick="histograma(this)">
<br>
<img id="display">
<div id="chart_div" style="width: 100%; height: 500px;"></div>
<div id="chart_div2" style="width: 100%; height: 500px;"></div>
</body>
</html>
